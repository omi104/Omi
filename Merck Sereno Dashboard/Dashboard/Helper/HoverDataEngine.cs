using System.Collections.Generic;
using System.Linq;
using Dashboard.Configuration;
using Dashboard.DataComponents.DataSources;
using Dashboard.DataComponents.Transformers;

namespace Dashboard.Helper
{
    public class HoverDataEngine
    {
        private readonly CubeDataSourceBase _dataSource;

        public HoverDataEngine()
        {
            _dataSource = new CubeDataSourceBase();
        }

        public HoverData GetData(string hoverValue, IReadOnlyDictionary<string, string> parameters)
        {
            string mappedValue = new MarketReportHelper().GetMarketSpecificMapping(parameters);
            var dictionary = parameters.ToDictionary(p => p.Key, p => p.Value);
            dictionary[ParameterList.RbMarket] = mappedValue;
            dictionary.Add(ParameterList.HoverRowItem, hoverValue);

            _dataSource.ModuleName = "901";
            _dataSource.Parameters = dictionary;

            var data = _dataSource.GetData();
            var transformer = new HoverDataTransformer
            {
                MeasureText = parameters["@@Measure_text"],
                PeriodType = parameters["@@PeriodType_text"],
                HoverItem = hoverValue,
                Input = data
            };

            var tdata = transformer.GetData();
            tdata.Table = tdata.TableNode.Render();
            tdata.Table = tdata.Table.Replace("\"", "'");
            return tdata;
            //return tdata = "<?xml version='1.0' encoding='utf-16'?><table id='hover-table' class='latest-data-hover'><thead><tr><th class='col-1'></th><th class='col-3'><div class='snapshot-hover-compnay'>NOVARTIS</div><div class='snapshot-hover-head'><span class='snapshot-hover-year'>2012</span><span class='snapshot-hover-measure'>:$ Value Retail</span></div></th><th class='col-4'><div class='snapshot-hover-compnay'>NOVARTIS</div><div class='snapshot-hover-head'><span class='snapshot-hover-year'>2012</span><span class='snapshot-hover-measure'>:Share%*</span></div></th><th class='col-5'><div class='snapshot-hover-compnay'>NOVARTIS</div><div class='snapshot-hover-head'><span class='snapshot-hover-year'>2013</span><span class='snapshot-hover-measure'>:$ Value Retail</span></div></th><th class='col-6'><div class='snapshot-hover-compnay'>NOVARTIS</div><div class='snapshot-hover-head'><span class='snapshot-hover-year'>2013</span><span class='snapshot-hover-measure'>:Share%*</span></div></th><th class='col-7'><div class='snapshot-hover-compnay'>NOVARTIS</div><div class='snapshot-hover-head'><span class='snapshot-hover-year'>2013</span><span class='snapshot-hover-measure'>:Growth % VYA*</span></div></th><th class='col-8'><div class='snapshot-hover-compnay'>NOVARTIS</div><div class='snapshot-hover-head'><span class='snapshot-hover-year'>2014</span><span class='snapshot-hover-measure'>:$ Value Retail</span></div></th><th class='col-9'><div class='snapshot-hover-compnay'>NOVARTIS</div><div class='snapshot-hover-head'><span class='snapshot-hover-year'>2014</span><span class='snapshot-hover-measure'>:Share%*</span></div></th><th class='col-10'><div class='snapshot-hover-compnay'>NOVARTIS</div><div class='snapshot-hover-head'><span class='snapshot-hover-year'>2014</span><span class='snapshot-hover-measure'>:Growth % VYA*</span></div></th></tr></thead><tbody><tr id='Row-1' class=' Level-1 Rank-1 even' Level='1' Rank='1'><td class='col-1'>BALKANS</td><td class='col-3'><div style='display:inline'>9'237</div></td><td class='col-4'><div style='display:inline'>23.1%</div></td><td class='col-5 has-indicator'><div style='display:inline'>10'452</div><img src='Content/Images/green.gif'></img></td><td class='col-6 has-indicator'><div style='display:inline'>23.4%</div><img src='Content/Images/green.gif'></img></td><td class='col-7 has-indicator'><div style='display:inline'>13.1%</div><img src='Content/Images/yellow.gif'></img></td><td class='col-8 has-indicator'><div style='display:inline'>16'871</div><img src='Content/Images/green.gif'></img></td><td class='col-9 has-indicator'><div style='display:inline'>31.5%</div><img src='Content/Images/green.gif'></img></td><td class='col-10 has-indicator'><div style='display:inline'>61.4%</div><img src='Content/Images/green.gif'></img></td></tr><tr id='Row-2' class=' Level-1 Rank-2 odd' Level='1' Rank='2'><td class='col-1'>BALTICS</td><td class='col-3'><div style='display:inline'>4'004</div></td><td class='col-4'><div style='display:inline'>19.3%</div></td><td class='col-5 has-indicator'><div style='display:inline'>4'488</div><img src='Content/Images/green.gif'></img></td><td class='col-6 has-indicator'><div style='display:inline'>18.5%</div><img src='Content/Images/red.gif'></img></td><td class='col-7 has-indicator'><div style='display:inline'>12.1%</div><img src='Content/Images/yellow.gif'></img></td><td class='col-8 has-indicator'><div style='display:inline'>5'503</div><img src='Content/Images/green.gif'></img></td><td class='col-9 has-indicator'><div style='display:inline'>21.4%</div><img src='Content/Images/green.gif'></img></td><td class='col-10 has-indicator'><div style='display:inline'>22.6%</div><img src='Content/Images/green.gif'></img></td></tr><tr id='Row-3' class=' Level-1 Rank-3 even' Level='1' Rank='3'><td class='col-1'>CENTRAL EASTERN EUROPE</td><td class='col-3'><div style='display:inline'>10'175</div></td><td class='col-4'><div style='display:inline'>6.7%</div></td><td class='col-5 has-indicator'><div style='display:inline'>13'331</div><img src='Content/Images/green.gif'></img></td><td class='col-6 has-indicator'><div style='display:inline'>7.4%</div><img src='Content/Images/green.gif'></img></td><td class='col-7 has-indicator'><div style='display:inline'>31.0%</div><img src='Content/Images/red.gif'></img></td><td class='col-8 has-indicator'><div style='display:inline'>15'245</div><img src='Content/Images/green.gif'></img></td><td class='col-9 has-indicator'><div style='display:inline'>7.9%</div><img src='Content/Images/green.gif'></img></td><td class='col-10 has-indicator'><div style='display:inline'>14.4%</div><img src='Content/Images/red.gif'></img></td></tr><tr id='Row-4' class=' Level-1 Rank-4 odd' Level='1' Rank='4'><td class='col-1'>DASHB</td><td class='col-3'><div style='display:inline'>25'201</div></td><td class='col-4'><div style='display:inline'>7.0%</div></td><td class='col-5 has-indicator'><div style='display:inline'>26'871</div><img src='Content/Images/green.gif'></img></td><td class='col-6 has-indicator'><div style='display:inline'>6.6%</div><img src='Content/Images/red.gif'></img></td><td class='col-7 has-indicator'><div style='display:inline'>6.6%</div><img src='Content/Images/yellow.gif'></img></td><td class='col-8 has-indicator'><div style='display:inline'>25'493</div><img src='Content/Images/red.gif'></img></td><td class='col-9 has-indicator'><div style='display:inline'>6.2%</div><img src='Content/Images/red.gif'></img></td><td class='col-10 has-indicator'><div style='display:inline'>-5.1%</div><img src='Content/Images/red.gif'></img></td></tr><tr id='Row-5' class=' Level-1 Rank-5 even' Level='1' Rank='5'><td class='col-1'>FRANCE.</td><td class='col-3'><div style='display:inline'>3'592</div></td><td class='col-4'><div style='display:inline'>1.6%</div></td><td class='col-5 has-indicator'><div style='display:inline'>4'752</div><img src='Content/Images/green.gif'></img></td><td class='col-6 has-indicator'><div style='display:inline'>2.0%</div><img src='Content/Images/green.gif'></img></td><td class='col-7 has-indicator'><div style='display:inline'>32.3%</div><img src='Content/Images/yellow.gif'></img></td><td class='col-8 has-indicator'><div style='display:inline'>4'516</div><img src='Content/Images/red.gif'></img></td><td class='col-9 has-indicator'><div style='display:inline'>1.8%</div><img src='Content/Images/red.gif'></img></td><td class='col-10 has-indicator'><div style='display:inline'>-5.0%</div><img src='Content/Images/red.gif'></img></td></tr><tr id='Row-6' class=' Level-1 Rank-6 odd' Level='1' Rank='6'><td class='col-1'>GREECE.</td><td class='col-3'><div style='display:inline'>9'602</div></td><td class='col-4'><div style='display:inline'>23.5%</div></td><td class='col-5 has-indicator'><div style='display:inline'>9'688</div><img src='Content/Images/green.gif'></img></td><td class='col-6 has-indicator'><div style='display:inline'>26.8%</div><img src='Content/Images/green.gif'></img></td><td class='col-7 has-indicator'><div style='display:inline'>0.9%</div><img src='Content/Images/yellow.gif'></img></td><td class='col-8 has-indicator'><div style='display:inline'>9'188</div><img src='Content/Images/red.gif'></img></td><td class='col-9 has-indicator'><div style='display:inline'>25.9%</div><img src='Content/Images/red.gif'></img></td><td class='col-10 has-indicator'><div style='display:inline'>-5.2%</div><img src='Content/Images/red.gif'></img></td></tr><tr id='Row-7' class=' Level-1 Rank-7 even' Level='1' Rank='7'><td class='col-1'>MENAP</td><td class='col-3'><div style='display:inline'>5'505</div></td><td class='col-4'><div style='display:inline'>8.4%</div></td><td class='col-5 has-indicator'><div style='display:inline'>7'306</div><img src='Content/Images/green.gif'></img></td><td class='col-6 has-indicator'><div style='display:inline'>8.3%</div><img src='Content/Images/red.gif'></img></td><td class='col-7 has-indicator'><div style='display:inline'>32.7%</div><img src='Content/Images/yellow.gif'></img></td><td class='col-8 has-indicator'><div style='display:inline'>8'714</div><img src='Content/Images/green.gif'></img></td><td class='col-9 has-indicator'><div style='display:inline'>8.3%</div><img src='Content/Images/yellow.gif'></img></td><td class='col-10 has-indicator'><div style='display:inline'>19.3%</div><img src='Content/Images/red.gif'></img></td></tr><tr id='Row-8' class=' Level-1 Rank-8 odd' Level='1' Rank='8'><td class='col-1'>NORDICS</td><td class='col-3'><div style='display:inline'>--</div></td><td class='col-4'><div style='display:inline'>0.0%</div></td><td class='col-5 has-indicator'><div style='display:inline'>1'379</div><img src='Content/Images/green.gif'></img></td><td class='col-6 has-indicator'><div style='display:inline'>3.6%</div><img src='Content/Images/green.gif'></img></td><td class='col-7'><div style='display:inline'>--</div></td><td class='col-8 has-indicator'><div style='display:inline'>1'717</div><img src='Content/Images/green.gif'></img></td><td class='col-9 has-indicator'><div style='display:inline'>4.2%</div><img src='Content/Images/green.gif'></img></td><td class='col-10 has-indicator'><div style='display:inline'>24.5%</div><img src='Content/Images/yellow.gif'></img></td></tr><tr id='Row-9' class=' Level-1 Rank-9 even' Level='1' Rank='9'><td class='col-1'>SOUTH AFRICA.</td><td class='col-3'><div style='display:inline'>2'378</div></td><td class='col-4'><div style='display:inline'>23.7%</div></td><td class='col-5 has-indicator'><div style='display:inline'>2'608</div><img src='Content/Images/green.gif'></img></td><td class='col-6 has-indicator'><div style='display:inline'>24.1%</div><img src='Content/Images/green.gif'></img></td><td class='col-7 has-indicator'><div style='display:inline'>9.7%</div><img src='Content/Images/green.gif'></img></td><td class='col-8 has-indicator'><div style='display:inline'>2'846</div><img src='Content/Images/green.gif'></img></td><td class='col-9 has-indicator'><div style='display:inline'>23.9%</div><img src='Content/Images/red.gif'></img></td><td class='col-10 has-indicator'><div style='display:inline'>9.1%</div><img src='Content/Images/red.gif'></img></td></tr><tr id='Row-10' class=' Level-1 Rank-10 odd' Level='1' Rank='10'><td class='col-1'>SOUTHERN EUROPE</td><td class='col-3'><div style='display:inline'>30'210</div></td><td class='col-4'><div style='display:inline'>4.2%</div></td><td class='col-5 has-indicator'><div style='display:inline'>27'665</div><img src='Content/Images/red.gif'></img></td><td class='col-6 has-indicator'><div style='display:inline'>3.5%</div><img src='Content/Images/red.gif'></img></td><td class='col-7 has-indicator'><div style='display:inline'>-8.4%</div><img src='Content/Images/red.gif'></img></td><td class='col-8 has-indicator'><div style='display:inline'>29'804</div><img src='Content/Images/green.gif'></img></td><td class='col-9 has-indicator'><div style='display:inline'>3.7%</div><img src='Content/Images/green.gif'></img></td><td class='col-10 has-indicator'><div style='display:inline'>7.7%</div><img src='Content/Images/green.gif'></img></td></tr><tr id='Row-11' class=' Level-1 Rank-11 even' Level='1' Rank='11'><td class='col-1'>TURKEY.</td><td class='col-3'><div style='display:inline'>14'473</div></td><td class='col-4'><div style='display:inline'>31.4%</div></td><td class='col-5 has-indicator'><div style='display:inline'>16'494</div><img src='Content/Images/green.gif'></img></td><td class='col-6 has-indicator'><div style='display:inline'>28.8%</div><img src='Content/Images/red.gif'></img></td><td class='col-7 has-indicator'><div style='display:inline'>14.0%</div><img src='Content/Images/yellow.gif'></img></td><td class='col-8 has-indicator'><div style='display:inline'>19'550</div><img src='Content/Images/green.gif'></img></td><td class='col-9 has-indicator'><div style='display:inline'>30.0%</div><img src='Content/Images/green.gif'></img></td><td class='col-10 has-indicator'><div style='display:inline'>18.5%</div><img src='Content/Images/green.gif'></img></td></tr><tr id='Row-12' class=' Level-1 Rank-12 odd' Level='1' Rank='12'><td class='col-1'>UK-IRELAND</td><td class='col-3'><div style='display:inline'>2'440</div></td><td class='col-4'><div style='display:inline'>7.1%</div></td><td class='col-5 has-indicator'><div style='display:inline'>2'612</div><img src='Content/Images/green.gif'></img></td><td class='col-6 has-indicator'><div style='display:inline'>6.7%</div><img src='Content/Images/red.gif'></img></td><td class='col-7 has-indicator'><div style='display:inline'>7.0%</div><img src='Content/Images/yellow.gif'></img></td><td class='col-8 has-indicator'><div style='display:inline'>2'276</div><img src='Content/Images/red.gif'></img></td><td class='col-9 has-indicator'><div style='display:inline'>5.5%</div><img src='Content/Images/red.gif'></img></td><td class='col-10 has-indicator'><div style='display:inline'>-12.9%</div><img src='Content/Images/red.gif'></img></td></tr></tbody><tfoot /></table>";
        }
    }
}